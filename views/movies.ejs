<%- include('partials/header') %>

<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/search">Search</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= movie.title %></li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-8">
      <div class="movie-detail-card">
        <div class="card bg-dark text-white">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><%= movie.title %></h2>
            <span class="badge bg-primary"><%= movie.runtime %> min</span>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center mb-3">
                <div style="height: 300px; background-color: #30363d; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                  <i class="fas fa-film fa-5x text-secondary"></i>
                </div>
                
                <div class="mt-3">
                  <% if (movie.genres) { %>
                    <% const genreList = typeof movie.genres === 'string' ? movie.genres.split(',') : movie.genres; %>
                    <% genreList.forEach(function(genre) { %>
                      <span class="genre-badge"><%= genre.trim() %></span>
                    <% }); %>
                  <% } %>
                </div>
                
                <div class="mt-3 d-flex justify-content-between">
                  <div>
                    <i class="fas fa-fire text-danger"></i>
                    <span><%= parseFloat(movie.popularity).toFixed(1) %></span>
                  </div>
                  <div>
                    <i class="fas fa-dollar-sign text-success"></i>
                    <span><%= movie.revenue ? '$' + (movie.revenue / 1000000).toFixed(1) + 'M' : 'N/A' %></span>
                  </div>
                  <div>
                    <i class="fas fa-language text-info"></i>
                    <span><%= movie.language || 'N/A' %></span>
                  </div>
                </div>
              </div>
              
              <div class="col-md-8">
                <% if (movie.tagline) { %>
                  <p class="fst-italic text-secondary mb-3">"<%= movie.tagline %>"</p>
                <% } %>
                
                <h5>Overview</h5>
                <p><%= movie.overview %></p>
                
                <div class="row mt-4">
                  <div class="col-sm-6 mb-3">
                    <h6><i class="fas fa-user me-2"></i>Director</h6>
                    <p><%= movie.director || 'N/A' %></p>
                  </div>
                  <div class="col-sm-12 mb-3">
                    <h6><i class="fas fa-users me-2"></i>Cast</h6>
                    <p><%= movie.cast || 'N/A' %></p>
                  </div>
                  <div class="col-sm-12 mb-3">
                    <h6><i class="fas fa-tags me-2"></i>Keywords</h6>
                    <p>
                      <% if (movie.keywords) { %>
                        <% const keywordList = typeof movie.keywords === 'string' ? movie.keywords.split(',') : movie.keywords; %>
                        <% keywordList.forEach(function(keyword) { %>
                          <span class="badge bg-secondary me-1"><%= keyword.trim() %></span>
                        <% }); %>
                      <% } else { %>
                        N/A
                      <% } %>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Similar Movies -->
      <div class="similar-movies-section mt-4">
        <h4><i class="fas fa-magic me-2"></i>Similar Movies</h4>
        
        <% if (similarMovies && similarMovies.length > 0) { %>
          <div class="row row-cols-1 row-cols-md-3 g-4">
            <% similarMovies.forEach(function(similar) { %>
              <div class="col">
                <div class="movie-card h-100">
                  <div class="card-img-top d-flex align-items-center justify-content-center">
                    <i class="fas fa-film fa-3x text-secondary"></i>
                </div>
                <div class="card-body">
                  <h6 class="movie-title"><%= similar.title %></h6>
                  
                  <div class="mb-2">
                    <% if (similar.genres) { %>
                      <% const genreList = typeof similar.genres === 'string' ? similar.genres.split(',') : similar.genres; %>
                      <% genreList.slice(0, 2).forEach(function(genre) { %>
                        <span class="genre-badge"><%= genre.trim() %></span>
                      <% }); %>
                      <% if (genreList.length > 2) { %>
                        <span class="genre-badge">+<%= genreList.length - 2 %></span>
                      <% } %>
                    <% } %>
                  </div>
                  
                  <% if (similar.overview) { %>
                    <p class="overview-text"><%= similar.overview.substring(0, 100) %>...</p>
                  <% } %>
                  
                  <a href="/movies/<%= similar.movie_id %>" class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-info-circle me-1"></i>View Details
                  </a>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="alert alert-info">
          No similar movies found.
        </div>
      <% } %>
    </div>
  </div>
  
  <div class="col-lg-4 mt-4 mt-lg-0">
    <!-- Recommendations Section -->
    <div class="history-panel">
      <h5 class="p-3 border-bottom"><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
      <div id="recommendationsContainer" class="p-3">
        <!-- Recommendations will be loaded here -->
      </div>
    </div>
    
    <!-- History panel -->
    <div class="history-panel mt-4">
      <ul class="nav nav-tabs" id="historyTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="searches-tab" data-bs-toggle="tab" data-bs-target="#searches-content" type="button" role="tab">
            Searches <span id="searchHistoryCount" class="badge bg-secondary">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="viewed-tab" data-bs-toggle="tab" data-bs-target="#viewed-content" type="button" role="tab">
            Viewed <span id="viewHistoryCount" class="badge bg-secondary">0</span>
          </button>
        </li>
      </ul>
      <div class="tab-content p-3" id="historyTabsContent">
        <div class="tab-pane fade show active" id="searches-content" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Search History</h6>
            <button class="btn btn-sm btn-outline-danger" onclick="UserHistory.clearHistory()">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
          <ul id="searchHistoryList" class="list-group list-group-flush">
          </ul>
        </div>
        <div class="tab-pane fade" id="viewed-content" role="tabpanel">
          <h6 class="mb-2">Recently Viewed</h6>
          <ul id="viewHistoryList" class="list-group list-group-flush">
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  viewMovieDetails('<%= movie.id %>');
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/history.js"></script>